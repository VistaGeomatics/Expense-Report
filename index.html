<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vista Geomatics, Expense Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Local libs (self hosted in same GitHub folder) -->
  <script defer src="html2pdf.bundle.min.js"></script>
  <script defer src="pdf-lib.min.js"></script>

  <style>
    :root{
      --vista-blue:#165f7d;
      --vista-blue-light:#2a7fa3;
      --vista-blue-dark:#0b3045;
      --bg-body:#eef3f9;
      --bg-card:#ffffff;
      --border-soft:#d6e2f0;
      --text-main:#101827;
      --text-muted:#6b7280;
      --danger:#b42318;
      --ok:#067647;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:16px;
      font-family:"Inter",sans-serif;
      background:radial-gradient(circle at top,#f4f8fc 0%,#eef3f9 50%,#e9f0f7 100%);
      color:var(--text-main);
    }

    .wrap{max-width:1080px;margin:0 auto;}
    .card{
      background:var(--bg-card);
      border:1px solid var(--border-soft);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(11,48,69,.10);
      overflow:hidden;
    }

    header{
      padding:18px 18px 14px 18px;
      background:linear-gradient(135deg,var(--vista-blue-dark),var(--vista-blue));
      color:#fff;
      display:flex;
      align-items:flex-start;
      gap:14px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    header .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:240px;
    }
    header h1{
      margin:0;
      font-family:"Montserrat",sans-serif;
      font-size:20px;
      letter-spacing:.3px;
    }
    header .sub{
      margin:0;
      opacity:.9;
      font-size:13px;
    }

    header .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button{
      appearance:none;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      font-family:"Inter",sans-serif;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .btn-primary{background:#fff;color:var(--vista-blue-dark);}
    .btn-primary:hover{filter:brightness(.98);}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25);}
    .btn-ghost:hover{background:rgba(255,255,255,.18);}

    .content{padding:16px;}

    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:12px;
      color:var(--text-muted);
      font-weight:700;
    }
    input, select, textarea{
      font-family:"Inter",sans-serif;
      font-size:14px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border-soft);
      outline:none;
      background:#fff;
      color:var(--text-main);
      width:100%;
      min-width:0;
    }
    textarea{min-height:88px;resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(42,127,163,.65);
      box-shadow:0 0 0 3px rgba(42,127,163,.16);
    }

    .span-12{grid-column:span 12;}
    .span-6{grid-column:span 6;}
    .span-4{grid-column:span 4;}
    .span-3{grid-column:span 3;}
    .span-2{grid-column:span 2;}

    @media (max-width: 820px){
      .span-6,.span-4,.span-3,.span-2{grid-column:span 12;}
      header{gap:10px;}
      header .actions{justify-content:flex-start;width:100%;}
    }

    .section-title{
      margin:18px 0 10px 0;
      font-family:"Montserrat",sans-serif;
      font-size:14px;
      letter-spacing:.3px;
      color:var(--vista-blue-dark);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      background:#eef7fb;
      border:1px solid #d5edf7;
      color:var(--vista-blue-dark);
    }

    .table-wrap{
      width:100%;
      overflow:auto;
      border:1px solid var(--border-soft);
      border-radius:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
      background:#fff;
    }
    thead th{
      position:sticky;
      top:0;
      background:#f3f7fb;
      color:#1a2a33;
      text-align:left;
      font-size:12px;
      padding:10px;
      border-bottom:1px solid var(--border-soft);
      white-space:nowrap;
    }
    tbody td{
      padding:8px;
      border-bottom:1px solid #edf2f7;
      vertical-align:top;
    }

    /* Ensure entered content is visible, wrap lines (no cut off) */
    td input, td select, td textarea{
      width:100%;
      white-space:normal;
    }
    td textarea{min-height:44px;resize:vertical;}

    .controls-row{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .hint{
      font-size:12px;
      color:var(--text-muted);
      margin:0;
    }

    .right-tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .btn-small{
      padding:8px 10px;
      font-size:13px;
      border-radius:12px;
    }
    .btn-add{background:linear-gradient(135deg,var(--vista-blue),var(--vista-blue-light));color:#fff;}
    .btn-add:hover{filter:brightness(.98);}
    .btn-danger{background:#fff;color:var(--danger);border:1px solid rgba(180,35,24,.25);}
    .btn-danger:hover{background:rgba(180,35,24,.06);}

    .totals{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      margin-top:14px;
      align-items:end;
    }

    .totals .box{
      border:1px solid var(--border-soft);
      border-radius:14px;
      padding:12px;
      background:#fbfdff;
    }
    .totals .box h3{
      margin:0 0 6px 0;
      font-size:12px;
      color:var(--text-muted);
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .totals .box .val{
      font-size:20px;
      font-weight:900;
      color:var(--vista-blue-dark);
    }

    .receipt-area{
      border:1px dashed #c9d7e6;
      border-radius:14px;
      padding:12px;
      background:#fbfdff;
    }
    .receipt-area .top{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      align-items:center;
    }
    .receipt-list{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .receipt-card{
      border:1px solid var(--border-soft);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .receipt-thumb{
      width:62px;
      height:62px;
      border-radius:12px;
      border:1px solid #e6eef7;
      background:#f6f9fc;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .receipt-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .receipt-meta{
      flex:1 1 auto;
      min-width:0;
    }
    .receipt-meta .name{
      font-weight:900;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .receipt-meta .type{
      font-size:12px;
      color:var(--text-muted);
      margin-top:2px;
    }
    .receipt-meta .remove{
      margin-top:8px;
      background:#fff;
      border:1px solid #e6eef7;
      color:#24303a;
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .receipt-meta .remove:hover{background:#f4f8fc;}
    @media (max-width: 820px){
      .receipt-list{grid-template-columns:1fr;}
    }

    .footer{
      padding:12px 16px 16px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      border-top:1px solid var(--border-soft);
      background:#fbfdff;
    }
    .ver{
      font-size:12px;
      color:var(--text-muted);
      font-weight:700;
    }
    .status{
      font-size:12px;
      font-weight:800;
      color:var(--text-muted);
    }
    .status.ok{color:var(--ok);}
    .status.bad{color:var(--danger);}

    /* Hide number spinners globally for numeric fields */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    input[type="number"]{
      -moz-appearance:textfield;
      appearance:textfield;
    }

    /* Print helpers for html2pdf */
    .pdf-page-break{page-break-before:always;}
    .pdf-only{display:none;}
    .no-print{ }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="title">
          <h1>Vista Geomatics, Expense Report</h1>
          <p class="sub">Export to Legal portrait, receipts append as separate pages.</p>
        </div>

        <div class="actions no-print">
          <button class="btn-ghost" id="btnReset" type="button" title="Clear form">
            ‚ôªÔ∏è Reset
          </button>
          <button class="btn-primary" id="btnExport" type="button" title="Export as PDF">
            üìÑ Export PDF
          </button>
          <button class="btn-ghost" id="btnSubmit" type="button" title="Export then open email draft">
            ‚úâÔ∏è Submit
          </button>
        </div>
      </header>

      <div class="content" id="formRoot">
        <div class="grid">
          <div class="field span-4">
            <label for="employeeName">Employee Name</label>
            <input id="employeeName" autocomplete="name" placeholder="Full name" />
          </div>

          <div class="field span-4">
            <label for="reportMonth">Expense Month</label>
            <input id="reportMonth" type="month" />
          </div>

          <div class="field span-4">
            <label for="fileName">PDF File Name</label>
            <input id="fileName" placeholder="Expense Report, Name, YYYY-MM" />
          </div>

          <div class="field span-6">
            <label for="project">Project, Client, Notes</label>
            <textarea id="project" placeholder="Project code, client, brief notes"></textarea>
          </div>

          <div class="field span-6">
            <label for="department">Department Code</label>
            <select id="department">
              <option value="">Select department</option>
              <option>ADM</option>
              <option>CAL</option>
              <option>EDM</option>
              <option>FIE</option>
              <option>HSE</option>
              <option>IT</option>
              <option>MGMT</option>
              <option>SUR</option>
              <option>URB</option>
            </select>
          </div>
        </div>

        <div class="section-title">
          Expense Lines <span class="pill">Default 3 rows, add more as needed</span>
        </div>

        <div class="table-wrap">
          <table id="expenseTable">
            <thead>
              <tr>
                <th style="width:150px;">Date</th>
                <th style="width:160px;">Category</th>
                <th>Description</th>
                <th style="width:140px;">Amount</th>
                <th style="width:120px;">GST</th>
                <th style="width:140px;">Total</th>
                <th style="width:80px;">Del</th>
              </tr>
            </thead>
            <tbody id="expenseBody"></tbody>
          </table>
        </div>

        <div class="controls-row no-print">
          <p class="hint">Tip, on mobile scroll sideways if needed, exported PDF is sized to Legal portrait.</p>
          <div class="right-tools">
            <button class="btn-small btn-add" id="btnAddRow" type="button">‚ûï Add Row</button>
            <button class="btn-small btn-danger" id="btnRemoveBlank" type="button">üßπ Remove Empty Rows</button>
          </div>
        </div>

        <div class="totals">
          <div class="box span-4">
            <h3>Subtotal</h3>
            <div class="val" id="subtotalVal">$0.00</div>
          </div>
          <div class="box span-4">
            <h3>GST Total</h3>
            <div class="val" id="gstVal">$0.00</div>
          </div>
          <div class="box span-4">
            <h3>Grand Total</h3>
            <div class="val" id="grandVal">$0.00</div>
          </div>
        </div>

        <div class="section-title">
          Receipts <span class="pill">Each receipt exports on its own page</span>
        </div>

        <div class="receipt-area">
          <div class="top no-print">
            <div>
              <div style="font-weight:900;color:var(--vista-blue-dark);">Attach receipts</div>
              <div class="hint">Photos, JPG, PNG, PDF. PDFs will be appended as pages.</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
              <label style="display:inline-flex;gap:10px;align-items:center;cursor:pointer;font-weight:900;color:var(--vista-blue-dark);">
                <input id="receiptFiles" type="file" accept="image/*,application/pdf" multiple style="display:none;">
                <span class="btn-small btn-add" style="display:inline-flex;">üìé Add Receipts</span>
              </label>
            </div>
          </div>

          <div id="receiptList" class="receipt-list"></div>
        </div>
      </div>

      <div class="footer">
        <div class="ver">Version 3.3</div>
        <div class="status" id="statusMsg">Ready</div>
      </div>
    </div>
  </div>

  <!-- Hidden render area used for html2pdf so layout is consistent -->
  <div id="pdfRenderRoot" class="pdf-only"></div>

  <script>
    (function(){
      const VERSION = "3.3";
      const EMAIL_TO = "timesheets@vistageomatics.com";

      const expenseBody = document.getElementById("expenseBody");
      const btnAddRow = document.getElementById("btnAddRow");
      const btnRemoveBlank = document.getElementById("btnRemoveBlank");
      const btnExport = document.getElementById("btnExport");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnReset = document.getElementById("btnReset");

      const subtotalVal = document.getElementById("subtotalVal");
      const gstVal = document.getElementById("gstVal");
      const grandVal = document.getElementById("grandVal");

      const statusMsg = document.getElementById("statusMsg");
      const receiptInput = document.getElementById("receiptFiles");
      const receiptList = document.getElementById("receiptList");

      const employeeName = document.getElementById("employeeName");
      const reportMonth = document.getElementById("reportMonth");
      const fileName = document.getElementById("fileName");

      const pdfRenderRoot = document.getElementById("pdfRenderRoot");

      let receipts = []; // {id, name, type, file, dataUrl?, arrayBuffer?}

      function setStatus(text, kind){
        statusMsg.textContent = text;
        statusMsg.classList.remove("ok","bad");
        if(kind) statusMsg.classList.add(kind);
      }

      function money(n){
        const v = Number(n || 0);
        if(!isFinite(v)) return "$0.00";
        return v.toLocaleString(undefined,{style:"currency",currency:"CAD"});
      }

      function parseNum(v){
        const x = String(v ?? "").replace(/[^0-9.\-]/g,"");
        const n = Number(x);
        return isFinite(n) ? n : 0;
      }

      function defaultFileName(){
        const name = (employeeName.value || "Employee").trim().replace(/\s+/g," ");
        const m = reportMonth.value || new Date().toISOString().slice(0,7);
        return `Expense Report, ${name}, ${m}`;
      }

      function ensureFileName(){
        if(!fileName.value.trim()){
          fileName.value = defaultFileName();
        }
      }

      function makeRow(data){
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = data?.date || "";
        tdDate.appendChild(inpDate);

        const tdCat = document.createElement("td");
        const selCat = document.createElement("select");
        const cats = ["","Meals","Mileage","Fuel","Parking","Supplies","Accommodation","Tools","Training","Other"];
        cats.forEach(c=>{
          const o=document.createElement("option");
          o.value=c; o.textContent=c || "Select";
          selCat.appendChild(o);
        });
        selCat.value = data?.category || "";
        tdCat.appendChild(selCat);

        const tdDesc = document.createElement("td");
        const ta = document.createElement("textarea");
        ta.placeholder = "Details";
        ta.value = data?.desc || "";
        tdDesc.appendChild(ta);

        const tdAmt = document.createElement("td");
        const inpAmt = document.createElement("input");
        inpAmt.type = "text";
        inpAmt.inputMode = "decimal";
        inpAmt.placeholder = "0.00";
        inpAmt.value = data?.amount ?? "";
        tdAmt.appendChild(inpAmt);

        const tdGst = document.createElement("td");
        const inpGst = document.createElement("input");
        inpGst.type = "text";
        inpGst.inputMode = "decimal";
        inpGst.placeholder = "0.00";
        inpGst.value = data?.gst ?? "";
        tdGst.appendChild(inpGst);

        const tdTotal = document.createElement("td");
        const inpTot = document.createElement("input");
        inpTot.type = "text";
        inpTot.readOnly = true;
        inpTot.value = "";
        tdTotal.appendChild(inpTot);

        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-small btn-danger";
        delBtn.textContent = "üóëÔ∏è";
        delBtn.title = "Delete row";
        tdDel.appendChild(delBtn);

        tr.appendChild(tdDate);
        tr.appendChild(tdCat);
        tr.appendChild(tdDesc);
        tr.appendChild(tdAmt);
        tr.appendChild(tdGst);
        tr.appendChild(tdTotal);
        tr.appendChild(tdDel);

        function recalcRow(){
          const amt = parseNum(inpAmt.value);
          const gst = parseNum(inpGst.value);
          const tot = amt + gst;
          inpTot.value = (tot === 0 && (inpAmt.value==="" && inpGst.value==="")) ? "" : tot.toFixed(2);
          recalcTotals();
        }

        inpAmt.addEventListener("input", recalcRow);
        inpGst.addEventListener("input", recalcRow);

        delBtn.addEventListener("click", ()=>{
          tr.remove();
          recalcTotals();
        });

        // initial calc
        recalcRow();

        return tr;
      }

      function addRow(data){
        expenseBody.appendChild(makeRow(data));
      }

      function initRows(){
        expenseBody.innerHTML = "";
        addRow();
        addRow();
        addRow();
        recalcTotals();
      }

      function recalcTotals(){
        let sub=0, gst=0, grand=0;

        [...expenseBody.querySelectorAll("tr")].forEach(tr=>{
          const cells = tr.querySelectorAll("td");
          const amt = parseNum(cells[3].querySelector("input").value);
          const g = parseNum(cells[4].querySelector("input").value);
          const tot = amt + g;
          sub += amt;
          gst += g;
          grand += tot;
        });

        subtotalVal.textContent = money(sub);
        gstVal.textContent = money(gst);
        grandVal.textContent = money(grand);
      }

      function removeEmptyRows(){
        [...expenseBody.querySelectorAll("tr")].forEach(tr=>{
          const tds = tr.querySelectorAll("td");
          const date = tds[0].querySelector("input").value.trim();
          const cat = tds[1].querySelector("select").value.trim();
          const desc = tds[2].querySelector("textarea").value.trim();
          const amt = tds[3].querySelector("input").value.trim();
          const gst = tds[4].querySelector("input").value.trim();
          if(!date && !cat && !desc && !amt && !gst){
            tr.remove();
          }
        });
        recalcTotals();
      }

      btnAddRow.addEventListener("click", ()=>addRow());
      btnRemoveBlank.addEventListener("click", removeEmptyRows);

      employeeName.addEventListener("input", ()=>{
        if(!fileName.value.trim()) fileName.value = defaultFileName();
      });
      reportMonth.addEventListener("change", ()=>{
        if(!fileName.value.trim()) fileName.value = defaultFileName();
      });

      btnReset.addEventListener("click", ()=>{
        if(!confirm("Clear the form and receipts?")) return;
        employeeName.value = "";
        reportMonth.value = "";
        fileName.value = "";
        document.getElementById("project").value = "";
        document.getElementById("department").value = "";
        receipts = [];
        renderReceipts();
        initRows();
        setStatus("Ready", "");
      });

      receiptInput.addEventListener("change", async (e)=>{
        const files = [...(e.target.files || [])];
        if(!files.length) return;

        setStatus("Loading receipts‚Ä¶", "");

        for(const f of files){
          const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random();
          const entry = {id, name:f.name, type:f.type, file:f};

          if(f.type === "application/pdf"){
            entry.arrayBuffer = await f.arrayBuffer();
          }else if(f.type.startsWith("image/")){
            entry.dataUrl = await readAsDataURL(f);
          }else{
            // ignore unknown
            continue;
          }
          receipts.push(entry);
        }

        receiptInput.value = "";
        renderReceipts();
        setStatus("Receipts added", "ok");
        setTimeout(()=>setStatus("Ready",""), 900);
      });

      function readAsDataURL(file){
        return new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      }

      function renderReceipts(){
        receiptList.innerHTML = "";
        receipts.forEach(r=>{
          const card = document.createElement("div");
          card.className = "receipt-card";

          const thumb = document.createElement("div");
          thumb.className = "receipt-thumb";
          if(r.type === "application/pdf"){
            thumb.textContent = "PDF";
            thumb.style.fontWeight = "900";
            thumb.style.color = "var(--vista-blue-dark)";
          }else{
            const img = document.createElement("img");
            img.alt = r.name;
            img.src = r.dataUrl;
            thumb.appendChild(img);
          }

          const meta = document.createElement("div");
          meta.className = "receipt-meta";
          const name = document.createElement("div");
          name.className = "name";
          name.textContent = r.name;

          const type = document.createElement("div");
          type.className = "type";
          type.textContent = (r.type === "application/pdf") ? "PDF receipt" : "Image receipt";

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "remove no-print";
          remove.textContent = "Remove";
          remove.addEventListener("click", ()=>{
            receipts = receipts.filter(x=>x.id !== r.id);
            renderReceipts();
          });

          meta.appendChild(name);
          meta.appendChild(type);
          meta.appendChild(remove);

          card.appendChild(thumb);
          card.appendChild(meta);
          receiptList.appendChild(card);
        });
      }

      function buildPdfHtmlClone(){
        // Clone the visible form root, remove buttons, ensure widths are stable for legal portrait.
        const original = document.getElementById("formRoot");
        const clone = original.cloneNode(true);

        // Remove receipt buttons, and keep receipt list as a simple list
        clone.querySelectorAll(".no-print").forEach(el=>el.remove());

        // Wrap in a "page" container with known width matching legal portrait.
        const container = document.createElement("div");
        container.style.width = "816px"; // legal portrait at 96dpi, 8.5x14 = 816x1344
        container.style.minHeight = "1344px";
        container.style.padding = "16px";
        container.style.background = "#ffffff";
        container.style.fontFamily = '"Inter", sans-serif';
        container.style.color = "#101827";

        // Add a header block in pdf with title and meta
        const h = document.createElement("div");
        h.style.display = "flex";
        h.style.justifyContent = "space-between";
        h.style.alignItems = "flex-start";
        h.style.gap = "12px";
        h.style.marginBottom = "10px";

        const left = document.createElement("div");
        const t = document.createElement("div");
        t.textContent = "Vista Geomatics, Expense Report";
        t.style.fontFamily = '"Montserrat", sans-serif';
        t.style.fontWeight = "900";
        t.style.fontSize = "18px";
        t.style.color = "#0b3045";
        const s = document.createElement("div");
        s.textContent = `Employee: ${(employeeName.value||"").trim()} , Month: ${reportMonth.value||""} , Dept: ${document.getElementById("department").value||""}`;
        s.style.fontSize = "12px";
        s.style.color = "#6b7280";
        s.style.marginTop = "4px";

        left.appendChild(t);
        left.appendChild(s);

        const right = document.createElement("div");
        right.style.textAlign = "right";
        right.style.fontSize = "12px";
        right.style.color = "#6b7280";
        right.style.fontWeight = "800";
        const dt = new Date();
        right.textContent = `Generated: ${dt.toLocaleString()} , v${VERSION}`;

        h.appendChild(left);
        h.appendChild(right);

        // Make tables fit page, avoid right cut off
        const tableWrap = clone.querySelector(".table-wrap");
        if(tableWrap){
          tableWrap.style.overflow = "visible";
          tableWrap.style.border = "1px solid #d6e2f0";
          tableWrap.style.borderRadius = "12px";
        }
        const table = clone.querySelector("table");
        if(table){
          table.style.minWidth = "0";
          table.style.width = "100%";
        }

        // Remove sticky header in PDF context
        clone.querySelectorAll("thead th").forEach(th=>{
          th.style.position = "static";
          th.style.top = "auto";
        });

        container.appendChild(h);
        container.appendChild(clone);

        // Footer line
        const footer = document.createElement("div");
        footer.style.marginTop = "10px";
        footer.style.fontSize = "11px";
        footer.style.color = "#6b7280";
        footer.style.fontWeight = "800";
        footer.textContent = "Receipts follow on separate pages.";
        container.appendChild(footer);

        return container;
      }

      async function exportBaseFormPdfBytes(){
        ensureFileName();

        // Build a stable HTML node for html2pdf
        pdfRenderRoot.innerHTML = "";
        const node = buildPdfHtmlClone();
        pdfRenderRoot.appendChild(node);

        // Temporarily show render root (html2canvas needs it in DOM)
        pdfRenderRoot.style.display = "block";
        pdfRenderRoot.style.position = "fixed";
        pdfRenderRoot.style.left = "-99999px";
        pdfRenderRoot.style.top = "0";
        pdfRenderRoot.style.width = "816px";

        const opt = {
          margin: 0,
          filename: (fileName.value.trim() || "Expense Report") + ".pdf",
          image: { type: "jpeg", quality: 0.95 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: "#ffffff",
            windowWidth: 816
          },
          jsPDF: { unit: "pt", format: "legal", orientation: "portrait" }
        };

        // html2pdf gives a jsPDF instance, pull bytes
        const worker = html2pdf().set(opt).from(node).toPdf();
        const pdf = await worker.get("pdf");
        const bytes = pdf.output("arraybuffer");

        // Clean up
        pdfRenderRoot.innerHTML = "";
        pdfRenderRoot.style.display = "none";

        return bytes;
      }

      async function appendReceiptsToPdf(baseBytes){
        if(!receipts.length) return baseBytes;

        if(!window.PDFLib || !PDFLib.PDFDocument){
          throw new Error("pdf-lib not loaded, make sure pdf-lib.min.js is in the same folder.");
        }

        const { PDFDocument } = PDFLib;

        const outDoc = await PDFDocument.load(baseBytes);

        for(const r of receipts){
          if(r.type === "application/pdf"){
            const src = await PDFDocument.load(r.arrayBuffer);
            const pages = await outDoc.copyPages(src, src.getPageIndices());
            pages.forEach(p=>outDoc.addPage(p));
          }else if(r.type.startsWith("image/")){
            // Create a new legal page and place image scaled to fit
            const page = outDoc.addPage([612, 1008]); // legal portrait in points (8.5x14)
            const imgBytes = dataURLToUint8Array(r.dataUrl);
            let img;
            if(r.type === "image/png"){
              img = await outDoc.embedPng(imgBytes);
            }else{
              img = await outDoc.embedJpg(imgBytes);
            }

            const margin = 36;
            const pageW = 612, pageH = 1008;
            const maxW = pageW - margin*2;
            const maxH = pageH - margin*2 - 24;

            const dims = img.scale(1);
            const scale = Math.min(maxW / dims.width, maxH / dims.height);

            const drawW = dims.width * scale;
            const drawH = dims.height * scale;

            // Title
            page.drawText(r.name, {
              x: margin,
              y: pageH - margin - 16,
              size: 12
            });

            page.drawImage(img, {
              x: (pageW - drawW)/2,
              y: (pageH - margin - 24) - drawH,
              width: drawW,
              height: drawH
            });
          }
        }

        const finalBytes = await outDoc.save();
        return finalBytes.buffer;
      }

      function dataURLToUint8Array(dataURL){
        const base64 = dataURL.split(",")[1];
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i);
        return bytes;
      }

      async function exportPdf({download=true}={}){
        try{
          setStatus("Building PDF‚Ä¶", "");
          const baseBytes = await exportBaseFormPdfBytes();

          setStatus("Appending receipts‚Ä¶", "");
          const finalBytes = await appendReceiptsToPdf(baseBytes);

          const blob = new Blob([finalBytes], {type:"application/pdf"});
          const name = (fileName.value.trim() || "Expense Report") + ".pdf";

          if(download){
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
          }

          setStatus("PDF ready", "ok");
          setTimeout(()=>setStatus("Ready",""), 900);

          return {blob, name};
        }catch(err){
          console.error(err);
          setStatus(String(err.message || err), "bad");
          return null;
        }
      }

      btnExport.addEventListener("click", async ()=>{
        await exportPdf({download:true});
      });

      btnSubmit.addEventListener("click", async ()=>{
        const res = await exportPdf({download:true});
        if(!res) return;

        // Self contained GitHub friendly submit: open email draft, user attaches the downloaded PDF
        const subject = encodeURIComponent(`Expense Report, ${employeeName.value || ""} , ${reportMonth.value || ""}`);
        const body = encodeURIComponent(
          `Hi,\n\nPlease find my Expense Report attached.\n\nFile: ${res.name}\n\nThank you,\n${employeeName.value || ""}`
        );

        // open default email client on PC/iPad
        window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
      });

      // Init
      initRows();
      fileName.value = defaultFileName();
      setStatus("Ready", "");

    })();
  </script>
</body>
</html>
