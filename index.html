<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vista Geomatics, Expense Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --vista-blue:#165f7d;
      --vista-blue-light:#2a7fa3;
      --vista-blue-dark:#0b3045;
      --bg-card:#ffffff;
      --border-soft:#d6e2f0;
      --text-main:#101827;
      --text-muted:#6b7280;
      --ok:#065f46;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:18px;
      font-family:"Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--text-main);
      background:radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
    }
    .page-wrap{ max-width:1400px; margin:0 auto; }
    .container{
      background:var(--bg-card);
      border-radius:18px;
      box-shadow:0 18px 40px rgba(5,41,66,0.18), 0 0 0 1px rgba(5,41,66,0.04);
      overflow:hidden;
      position:relative;
    }
    .container::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(circle at top right, rgba(22,95,125,0.18), transparent 55%);
      opacity:0.9;
    }

    .header-bar{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px 24px;
      background:linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color:#fff;
    }
    .header-left{ z-index:1; display:flex; flex-direction:column; gap:4px; }
    .header-left h1{
      margin:0;
      font-family:"Montserrat", sans-serif;
      font-weight:400;
      font-size:1.55rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      line-height:1.05;
    }
    .vista-bold{ font-weight:700; }
    .geomatics-regular{ font-weight:400; }
    .header-left p{ margin:0; font-size:0.95rem; opacity:0.92; }
    .header-logo{
      height:78px;
      width:auto;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,0.35));
      z-index:1;
      position:relative;
    }

    form{
      position:relative;
      z-index:2;
      padding:18px 22px 14px;
      background:radial-gradient(circle at top left, rgba(226,240,246,0.55), transparent 55%) #fff;
    }

    .section{
      margin-bottom:14px;
      padding:14px 16px 16px;
      border-radius:14px;
      border:1px solid var(--border-soft);
      background:linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow:0 10px 24px rgba(5,41,66,0.05);
      position:relative;
      overflow:hidden;
    }
    .section::before{
      content:"";
      position:absolute;
      top:0; left:0; right:0;
      height:5px;
      background:linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }
    .section-title{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:900;
      margin-bottom:6px;
      font-size:1.02rem;
      color:var(--vista-blue-dark);
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(22,95,125,0.09), rgba(11,48,69,0.05));
      box-shadow:0 0 0 1px rgba(22,95,125,0.12);
    }
    .section-subtext{
      font-size:0.82rem;
      color:var(--text-muted);
      margin:0 0 10px 0;
      line-height:1.35;
    }

    .grid-2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 900px){
      .grid-2{ grid-template-columns:1fr; }
    }

    label{
      font-size:0.86rem;
      font-weight:900;
      display:block;
      margin-bottom:4px;
    }
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      min-width:0;
      padding:10px 10px;
      font-size:0.94rem;
      border:1px solid var(--border-soft);
      border-radius:9px;
      background:#f9fbff;
      font-family:inherit;
      line-height:1.15;
    }
    textarea{
      resize:none;
      min-height:44px;
      line-height:1.25;
      white-space:pre-wrap;
      word-break:break-word;
      overflow:hidden;
    }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--vista-blue-light);
      background:#fff;
      box-shadow:0 0 0 3px rgba(38,132,168,0.22);
      transform:translateY(-1px);
    }

    .entries-wrap{ width:100%; overflow:hidden; }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:0.85rem;
      border-radius:10px;
      overflow:hidden;
      table-layout:fixed;
    }
    th, td{
      border:1px solid #d7e2f1;
      padding:8px 8px;
      vertical-align:top;
      word-break:break-word;
    }
    th{
      background:linear-gradient(90deg, #e6f1fb, #dde9f7);
      text-align:left;
      font-size:0.74rem;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:#4b5563;
      white-space:normal;
      line-height:1.15;
    }
    tbody tr:nth-child(even){ background:#f7faff; }
    .cell-tight{ padding:6px 7px; }
    td input, td textarea, td select{ width:100%; min-width:0; }

    .money-input, .km-input{ text-align:right; font-variant-numeric:tabular-nums; }

    .row-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .totals-bar{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:12px;
      align-items:end;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .totals-bar{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    .totals-box{
      border:1px solid var(--border-soft);
      border-radius:12px;
      background:#fff;
      padding:12px;
      box-shadow:0 8px 18px rgba(5,41,66,0.06);
    }
    .totals-box .label{
      font-size:0.74rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--text-muted);
      margin-bottom:6px;
      font-weight:900;
    }
    .totals-box .value{
      font-size:1.10rem;
      font-weight:900;
      color:var(--vista-blue-dark);
    }

    button{
      padding:9px 18px;
      font-size:0.9rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:900;
      letter-spacing:0.05em;
      text-transform:uppercase;
      transition:transform 0.12s ease, box-shadow 0.12s ease;
    }
    .btn-primary{
      background:linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color:#fff;
      box-shadow:0 10px 24px rgba(5,41,66,0.45);
    }
    .btn-secondary{
      background:#f3f4f6;
      color:var(--text-main);
      border:1px solid #d4d7dd;
    }
    .btn-ghost{
      background:#fff;
      color:var(--vista-blue-dark);
      border:1px solid var(--border-soft);
    }
    .btn-primary:hover, .btn-secondary:hover, .btn-ghost:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 26px rgba(5,41,66,0.18);
    }

    .status{
      font-size:0.9rem;
      font-weight:900;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border-soft);
      background:#fff;
      box-shadow:0 8px 18px rgba(5,41,66,0.06);
      display:none;
      margin-top:10px;
      max-width:980px;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .status.ok{ color:#065f46; }
    .status.bad{ color:#b91c1c; }

    /* Receipts preview (screen) */
    #receiptPreview{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .receipt-card{
      border:1px solid #d6e2f0;
      border-radius:12px;
      background:#fff;
      padding:10px;
      box-shadow:0 8px 18px rgba(5,41,66,0.06);
    }
    .receipt-caption{
      font-size:12px;
      font-weight:900;
      color:#374151;
      margin:2px 0 8px;
      word-break:break-word;
    }
    .receipt-img{
      width:100%;
      height:auto;
      display:block;
      border-radius:10px;
    }

    .footer-version{
      margin-top:8px;
      padding:0 4px 4px;
      text-align:right;
      font-size:0.78rem;
      color:var(--text-muted);
      user-select:none;
    }

    /* Hidden export area (captured into PDF) */
    #exportRoot{
      position:fixed;
      left:-99999px;
      top:0;
      width: 10.5in;          /* fixed “printable” width to prevent right cut-off */
      background:#fff;
      padding:12px;
    }

    .x-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid #d6e2f0;
      border-radius:12px;
      background:linear-gradient(120deg, rgba(42,127,163,0.16), rgba(22,95,125,0.08));
      margin-bottom:10px;
    }
    .x-title{
      font-family:"Montserrat", sans-serif;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-size:15px;
      margin:0;
      color:#0b3045;
    }
    .x-subtitle{ margin:2px 0 0 0; color:#374151; font-size:11px; font-weight:700; }
    .x-logo{ height:42px; width:auto; }

    .x-meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .x-box{
      border:1px solid #d6e2f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .x-label{ font-size:10px; font-weight:900; color:#4b5563; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px; }
    .x-value{ font-size:12px; font-weight:800; color:#111827; word-break:break-word; }
    .x-note{ font-size:10px; color:#6b7280; margin:6px 0 0 0; font-weight:900; }

    .x-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:10px;
    }
    .x-table th, .x-table td{
      border:1px solid #d7e2f1;
      padding:5px 5px;
      vertical-align:top;
      word-break:break-word;
    }
    .x-table th{
      background:linear-gradient(90deg, #e6f1fb, #dde9f7);
      color:#374151;
      text-transform:uppercase;
      letter-spacing:0.04em;
      font-size:9px;
      white-space:nowrap;
    }
    .x-nowrap{ white-space:nowrap; }

    .x-totals{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .x-totalbox{
      border:1px solid #d6e2f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .x-totalbox .k{ font-size:9px; font-weight:900; color:#6b7280; text-transform:uppercase; letter-spacing:0.05em; }
    .x-totalbox .v{ margin-top:6px; font-size:12px; font-weight:900; color:#0b3045; }

    .x-footer{
      margin-top:8px;
      text-align:right;
      font-size:10px;
      color:#6b7280;
      font-weight:900;
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="container" id="appArea">
      <div class="header-bar">
        <div class="header-left">
          <h1><span class="vista-bold">VISTA</span><span class="geomatics-regular">GEOMATICS</span></h1>
          <p>Employee Out of Pocket Expense Report</p>
        </div>
        <img src="vista-geomatics.png" alt="Vista Geomatics Logo" class="header-logo" />
      </div>

      <form id="expenseForm" autocomplete="off">
        <div class="section">
          <div class="section-title">Employee Information</div>
          <div class="grid-2">
            <div>
              <label for="employee_name">Name</label>
              <input type="text" id="employee_name" placeholder="Employee name" />
            </div>
            <div>
              <label for="report_date">Report Date</label>
              <input type="date" id="report_date" />
            </div>
          </div>
          <p class="section-subtext" style="margin-top:10px;">
            Department codes, Municipal 100, Oil and Gas 200, Office 300, Construction 400.
          </p>
        </div>

        <div class="section">
          <div class="section-title">Expense Entries</div>
          <p class="section-subtext">
            Starts with 3 rows, add more as needed. Descriptions can be long.
          </p>

          <div class="entries-wrap">
            <table id="expenseTable">
              <thead>
                <tr>
                  <th style="width:11%;">Date</th>
                  <th style="width:14%;">Vendor</th>
                  <th style="width:29%;">Item Description</th>
                  <th style="width:10%;">Subtotal</th>
                  <th style="width:8%;">GST</th>
                  <th style="width:10%;">Total</th>
                  <th style="width:10%;">Department</th>
                  <th style="width:8%;">Personal KM</th>
                </tr>
              </thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>

          <div class="row-actions">
            <button type="button" class="btn-ghost" id="addRowBtn">Add Row</button>
            <button type="button" class="btn-ghost" id="removeLastRowBtn">Remove Last Row</button>
          </div>

          <div class="totals-bar">
            <div class="totals-box"><div class="label">Subtotal Total</div><div class="value" id="subtotalSum">CA$0.00</div></div>
            <div class="totals-box"><div class="label">GST Total</div><div class="value" id="gstSum">CA$0.00</div></div>
            <div class="totals-box"><div class="label">Grand Total</div><div class="value" id="grandSum">CA$0.00</div></div>
            <div class="totals-box"><div class="label">Personal KM Total</div><div class="value" id="kmSum">0</div></div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Receipts</div>
          <p class="section-subtext">
            Photos only. PDF export will append receipts after the report, 2 per page, large and legible.
          </p>

          <div class="grid-2">
            <div>
              <label for="receiptPhotos">Receipt photos, take photo or upload</label>
              <input type="file" id="receiptPhotos" accept="image/*" multiple capture="environment" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button type="button" class="btn-ghost" id="clearReceiptsBtn" style="width:100%;">Clear Receipts</button>
            </div>
          </div>

          <div class="section-subtext" id="receiptCountText" style="margin-top:8px;">No receipts selected.</div>
          <div id="receiptPreview"></div>
        </div>

        <div class="section">
          <div class="section-title">Export and Submit</div>

          <div class="grid-2">
            <div>
              <label for="filename">File name</label>
              <input type="text" id="filename" placeholder="Expense Report, Name, YYYY-MM-DD" />
            </div>

            <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">
              <button type="button" class="btn-primary" id="exportBtn">Download PDF</button>
              <button type="button" class="btn-primary" id="submitBtn">Submit</button>
              <button type="button" class="btn-secondary" id="clearBtn">Clear</button>
            </div>
          </div>

          <p class="section-subtext" style="margin-top:10px;">
            Submit downloads the PDF, then opens an email draft to timesheets@vistageomatics.com.
            (Browsers cannot auto-attach files in email drafts.)
          </p>

          <div class="status" id="statusBox"></div>
        </div>

        <div class="footer-version" id="versionFooter"></div>
      </form>
    </div>
  </div>

  <!-- Hidden export root (captured by html2canvas) -->
  <div id="exportRoot" aria-hidden="true"></div>

  <!-- =========================
       EMBED LIBS (PASTE HERE)
       ========================= -->

  <script>
 <script src="./html2canvas.min.js"></script>
  */
  </script>

  <script>
<script src="./jspdf.umd.min.js"></script>
  */
  </script>

  <!-- =========================
       APP LOGIC
       ========================= -->
  <script>
    const VERSION = "1";
    const EMAIL_TO = "timesheets@vistageomatics.com";
    const DEFAULT_ROWS = 3;

    const tbody = document.getElementById("expenseTbody");
    const addRowBtn = document.getElementById("addRowBtn");
    const removeLastRowBtn = document.getElementById("removeLastRowBtn");

    const employeeNameEl = document.getElementById("employee_name");
    const reportDateEl = document.getElementById("report_date");
    const filenameEl = document.getElementById("filename");

    const subtotalSumEl = document.getElementById("subtotalSum");
    const gstSumEl = document.getElementById("gstSum");
    const grandSumEl = document.getElementById("grandSum");
    const kmSumEl = document.getElementById("kmSum");

    const exportBtn = document.getElementById("exportBtn");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");

    const receiptPhotosInput = document.getElementById("receiptPhotos");
    const receiptCountText = document.getElementById("receiptCountText");
    const clearReceiptsBtn = document.getElementById("clearReceiptsBtn");
    const receiptPreview = document.getElementById("receiptPreview");

    const statusBox = document.getElementById("statusBox");
    const versionFooter = document.getElementById("versionFooter");
    const exportRoot = document.getElementById("exportRoot");

    versionFooter.textContent = "Version " + VERSION;

    let receiptDataUrls = []; // [{name, dataUrl, w, h}]

    function setStatus(msg, kind){
      statusBox.style.display = "block";
      statusBox.classList.remove("ok","bad");
      if (kind) statusBox.classList.add(kind);
      statusBox.textContent = msg;
    }
    function clearStatus(){
      statusBox.style.display = "none";
      statusBox.textContent = "";
      statusBox.classList.remove("ok","bad");
    }

    function money(n){
      const num = Number(n || 0);
      return num.toLocaleString(undefined, { style:"currency", currency:"CAD" });
    }
    function parseMoney(str){
      const clean = String(str ?? "").replace(/[^0-9.\-]/g, "");
      const n = Number(clean);
      return Number.isFinite(n) ? n : 0;
    }
    function sanitizeFilename(name){
      return String(name || "Expense Report").replace(/[\\\/:*?"<>|]+/g, " ").trim();
    }
    function buildDefaultFilename(){
      const name = (employeeNameEl.value || "").trim() || "Employee";
      const date = reportDateEl.value ? reportDateEl.value : new Date().toISOString().slice(0,10);
      return `Expense Report, ${name}, ${date}`;
    }
    function autoGrow(el){
      if (!el) return;
      el.style.height = "auto";
      el.style.height = Math.max(44, el.scrollHeight) + "px";
    }

    function deptSelect(){
      const sel = document.createElement("select");
      sel.innerHTML = `
        <option value="">Select…</option>
        <option value="100">Municipal 100</option>
        <option value="200">Oil and Gas 200</option>
        <option value="300">Office 300</option>
        <option value="400">Construction 400</option>
      `;
      return sel;
    }

    function moneyInput(){
      const input = document.createElement("input");
      input.type = "text";
      input.inputMode = "decimal";
      input.autocomplete = "off";
      input.placeholder = "0.00";
      input.className = "money-input";
      return input;
    }
    function kmInput(){
      const input = document.createElement("input");
      input.type = "text";
      input.inputMode = "decimal";
      input.autocomplete = "off";
      input.placeholder = "";
      input.className = "km-input";
      return input;
    }

    function addRow(){
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td"); tdDate.className="cell-tight";
      const date = document.createElement("input"); date.type="date";
      tdDate.appendChild(date);

      const tdVendor = document.createElement("td"); tdVendor.className="cell-tight";
      const vendor = document.createElement("input"); vendor.type="text"; vendor.placeholder="Vendor";
      tdVendor.appendChild(vendor);

      const tdDesc = document.createElement("td"); tdDesc.className="cell-tight";
      const desc = document.createElement("textarea");
      desc.placeholder="Item description (can be long)";
      desc.addEventListener("input", () => autoGrow(desc));
      tdDesc.appendChild(desc);

      const tdSub = document.createElement("td"); tdSub.className="cell-tight";
      const sub = moneyInput(); tdSub.appendChild(sub);

      const tdGst = document.createElement("td"); tdGst.className="cell-tight";
      const gst = moneyInput(); tdGst.appendChild(gst);

      const tdTotal = document.createElement("td"); tdTotal.className="cell-tight";
      const total = moneyInput(); total.readOnly = true; total.tabIndex = -1;
      tdTotal.appendChild(total);

      const tdDept = document.createElement("td"); tdDept.className="cell-tight";
      const dept = deptSelect(); tdDept.appendChild(dept);

      const tdKm = document.createElement("td"); tdKm.className="cell-tight";
      const km = kmInput(); tdKm.appendChild(km);

      tr.append(tdDate, tdVendor, tdDesc, tdSub, tdGst, tdTotal, tdDept, tdKm);
      tbody.appendChild(tr);

      function recalcRow(){
        const s = parseMoney(sub.value);
        const g = parseMoney(gst.value);
        total.value = (s + g).toFixed(2);
        recalcTotals();
      }
      sub.addEventListener("input", recalcRow);
      gst.addEventListener("input", recalcRow);
      km.addEventListener("input", recalcTotals);

      autoGrow(desc);
      recalcTotals();
    }

    function removeLastRow(){
      if (tbody.children.length > 0){
        tbody.removeChild(tbody.lastElementChild);
        recalcTotals();
      }
    }

    function recalcTotals(){
      let subSum=0, gstSum=0, grand=0, kmSum=0;
      Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
        const sub = tr.querySelector("td:nth-child(4) input");
        const gst = tr.querySelector("td:nth-child(5) input");
        const tot = tr.querySelector("td:nth-child(6) input");
        const km  = tr.querySelector("td:nth-child(8) input");
        const s = parseMoney(sub?.value);
        const g = parseMoney(gst?.value);
        const t = parseMoney(tot?.value);
        const k = parseMoney(km?.value);
        subSum += s; gstSum += g; grand += t; kmSum += k;
      });

      subtotalSumEl.textContent = money(subSum);
      gstSumEl.textContent = money(gstSum);
      grandSumEl.textContent = money(grand);
      kmSumEl.textContent = (kmSum % 1 === 0) ? String(kmSum.toFixed(0)) : String(kmSum.toFixed(1));
    }

    function initRows(){
      tbody.innerHTML = "";
      for (let i=0; i<DEFAULT_ROWS; i++) addRow();
    }

    async function fileToDataUrl(file){
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(new Error("Could not read image file."));
        reader.readAsDataURL(file);
      });
    }

    async function getImageSize(dataUrl){
      return await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve({ w: img.naturalWidth || img.width, h: img.naturalHeight || img.height });
        img.onerror = () => reject(new Error("Could not load receipt image."));

        img.src = dataUrl;
      });
    }

    async function rebuildReceiptPreviewAndCache(){
      receiptPreview.innerHTML = "";
      receiptDataUrls = [];

      const files = Array.from(receiptPhotosInput.files || []);
      receiptCountText.textContent = files.length ? `${files.length} receipt photo(s) selected.` : "No receipts selected.";
      if (!files.length) return;

      setStatus("Loading receipt photos…", "");

      for (const f of files){
        const dataUrl = await fileToDataUrl(f);
        const sz = await getImageSize(dataUrl);
        receiptDataUrls.push({ name: f.name || "Receipt photo", dataUrl, w: sz.w, h: sz.h });

        const card = document.createElement("div");
        card.className = "receipt-card";

        const cap = document.createElement("div");
        cap.className = "receipt-caption";
        cap.textContent = f.name || "Receipt photo";
        card.appendChild(cap);

        const img = document.createElement("img");
        img.className = "receipt-img";
        img.src = dataUrl;
        card.appendChild(img);

        receiptPreview.appendChild(card);
      }

      setStatus("Receipts ready. Export will include them 2 per page, large.", "ok");
    }

    function clearReceipts(){
      receiptPhotosInput.value = "";
      receiptDataUrls = [];
      receiptCountText.textContent = "No receipts selected.";
      receiptPreview.innerHTML = "";
      setStatus("Receipts cleared.", "ok");
    }

    function getRowData(){
      const rows = [];
      Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
        const date = tr.querySelector("td:nth-child(1) input")?.value || "";
        const vendor = tr.querySelector("td:nth-child(2) input")?.value || "";
        const desc = tr.querySelector("td:nth-child(3) textarea")?.value || "";
        const sub = tr.querySelector("td:nth-child(4) input")?.value || "";
        const gst = tr.querySelector("td:nth-child(5) input")?.value || "";
        const total = tr.querySelector("td:nth-child(6) input")?.value || "";
        const deptSel = tr.querySelector("td:nth-child(7) select");
        const deptText = deptSel ? (deptSel.options[deptSel.selectedIndex]?.textContent || "") : "";
        const km = tr.querySelector("td:nth-child(8) input")?.value || "";
        rows.push({ date, vendor, desc, sub, gst, total, deptText, km });
      });
      return rows;
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildExportHTML(){
      const employee = (employeeNameEl.value || "").trim();
      const reportDate = (reportDateEl.value || "").trim();
      const fileName = sanitizeFilename(filenameEl.value || buildDefaultFilename());

      const rows = getRowData();
      const subtotalTotal = subtotalSumEl.textContent;
      const gstTotal = gstSumEl.textContent;
      const grandTotal = grandSumEl.textContent;
      const kmTotal = kmSumEl.textContent;

      const reportRowsHTML = rows.map(r => `
        <tr>
          <td class="x-nowrap">${esc(r.date)}</td>
          <td>${esc(r.vendor)}</td>
          <td>${esc(r.desc)}</td>
          <td class="x-nowrap">${esc(r.sub)}</td>
          <td class="x-nowrap">${esc(r.gst)}</td>
          <td class="x-nowrap">${esc(r.total)}</td>
          <td class="x-nowrap">${esc(r.deptText)}</td>
          <td class="x-nowrap">${esc(r.km)}</td>
        </tr>
      `).join("");

      return `
        <div class="x-header">
          <div>
            <p class="x-title">VISTA GEOMATICS</p>
            <p class="x-subtitle">Employee Out of Pocket Expense Report</p>
          </div>
          <img class="x-logo" src="vista-geomatics.png" alt="Vista Geomatics" />
        </div>

        <div class="x-meta">
          <div class="x-box">
            <div class="x-label">Name</div>
            <div class="x-value">${esc(employee)}</div>
          </div>
          <div class="x-box">
            <div class="x-label">Report Date</div>
            <div class="x-value x-nowrap">${esc(reportDate)}</div>
          </div>
        </div>

        <div class="x-box" style="margin-bottom:10px;">
          <div class="x-label">Department Codes</div>
          <div class="x-value" style="font-size:11px;">Municipal 100, Oil and Gas 200, Office 300, Construction 400</div>
          <p class="x-note">File name, ${esc(fileName)}.pdf</p>
        </div>

        <table class="x-table">
          <thead>
            <tr>
              <th style="width:9%;">Date</th>
              <th style="width:12%;">Vendor</th>
              <th style="width:28%;">Item Description</th>
              <th style="width:8%;">Subtotal</th>
              <th style="width:7%;">GST</th>
              <th style="width:8%;">Total</th>
              <th style="width:18%;">Department</th>
              <th style="width:10%;">Personal KM</th>
            </tr>
          </thead>
          <tbody>
            ${reportRowsHTML || `<tr><td colspan="8" style="color:#6b7280; font-weight:900;">No expense entries.</td></tr>`}
          </tbody>
        </table>

        <div class="x-totals">
          <div class="x-totalbox"><div class="k">Subtotal Total</div><div class="v">${esc(subtotalTotal)}</div></div>
          <div class="x-totalbox"><div class="k">GST Total</div><div class="v">${esc(gstTotal)}</div></div>
          <div class="x-totalbox"><div class="k">Grand Total</div><div class="v">${esc(grandTotal)}</div></div>
          <div class="x-totalbox"><div class="k">Personal KM Total</div><div class="v">${esc(kmTotal)}</div></div>
        </div>

        <div class="x-footer">Version ${VERSION}</div>
      `;
    }

    function ensureLibsLoaded(){
      if (typeof html2canvas !== "function") {
        throw new Error("html2canvas not loaded. Paste html2canvas.min.js into the script block.");
      }
      const jspdfNs = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf : (window.jspdf && window.jspdf.default ? window.jspdf : null);
      if (!jspdfNs || !jspdfNs.jsPDF) {
        throw new Error("jsPDF not loaded. Paste jspdf.umd.min.js into the script block.");
      }
      return jspdfNs.jsPDF;
    }

    async function canvasToPagedPdf(pdf, canvas, marginPt){
      // Letter landscape in points: 792 x 612
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const usableW = pageW - marginPt*2;
      const usableH = pageH - marginPt*2;

      const imgData = canvas.toDataURL("image/jpeg", 0.92);

      const canvasW = canvas.width;
      const canvasH = canvas.height;

      // scale to fit width
      const scale = usableW / canvasW;
      const scaledH = canvasH * scale;

      if (scaledH <= usableH){
        pdf.addImage(imgData, "JPEG", marginPt, marginPt, usableW, scaledH);
        return;
      }

      // Page slicing:
      // We draw the same image multiple times with negative y offset to simulate cropping.
      let yOffset = 0;
      let pageIndex = 0;

      while (yOffset < scaledH - 1){
        if (pageIndex > 0) pdf.addPage();

        // Place the full image but shifted up so the desired slice is visible
        pdf.addImage(
          imgData,
          "JPEG",
          marginPt,
          marginPt - yOffset,
          usableW,
          scaledH
        );

        yOffset += usableH;
        pageIndex += 1;
      }
    }

    function fitRect(imgW, imgH, boxW, boxH){
      const r = Math.min(boxW / imgW, boxH / imgH);
      return { w: imgW * r, h: imgH * r };
    }

    async function addReceiptPages(pdf, marginPt){
      if (!receiptDataUrls.length) return;

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const usableW = pageW - marginPt*2;
      const usableH = pageH - marginPt*2;

      // 2 per page: top + bottom
      const gap = 10; // pt
      const headerH = 0; // keep minimal for max image size
      const slotH = (usableH - gap - headerH) / 2;

      // New page for receipts
      pdf.addPage();

      let i = 0;
      while (i < receiptDataUrls.length){
        // If not first receipt page, we’re already on a clean page.
        // For first, we are already on the page created above.

        for (let slot = 0; slot < 2; slot++){
          if (i >= receiptDataUrls.length) break;

          const r = receiptDataUrls[i];
          const yTop = marginPt + headerH + (slot === 0 ? 0 : (slotH + gap));

          // Put a small caption
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(10);
          const caption = `Receipt ${i+1}: ${r.name || "Receipt"}`;
          pdf.text(caption.length > 90 ? caption.slice(0, 90) + "…" : caption, marginPt, yTop + 12);

          // Image box (below caption)
          const imgBoxY = yTop + 18;
          const imgBoxH = slotH - 22;
          const imgBoxW = usableW;

          const fitted = fitRect(r.w || 1000, r.h || 1000, imgBoxW, imgBoxH);
          const x = marginPt + (imgBoxW - fitted.w) / 2;
          const y = imgBoxY + (imgBoxH - fitted.h) / 2;

          // r.dataUrl is already a data URL. Use JPEG for smaller PDFs if possible.
          // If the data URL is PNG, jsPDF can still embed it, but size may be larger.
          const isPng = String(r.dataUrl).startsWith("data:image/png");
          pdf.addImage(r.dataUrl, isPng ? "PNG" : "JPEG", x, y, fitted.w, fitted.h);

          i++;
        }

        if (i < receiptDataUrls.length){
          pdf.addPage();
        }
      }
    }

    async function generatePdfBlob(){
      const jsPDF = ensureLibsLoaded();

      // Build export DOM
      exportRoot.innerHTML = buildExportHTML();

      // Wait for logo to load in export root (important for canvas capture)
      await new Promise((resolve) => setTimeout(resolve, 120));

      // Capture export root into canvas
      setStatus("Rendering report into PDF…", "");
      const canvas = await html2canvas(exportRoot, {
        backgroundColor: "#ffffff",
        scale: 2,                // sharper text
        useCORS: true,
        logging: false,
        windowWidth: exportRoot.scrollWidth
      });

      // Create PDF (Letter landscape)
      const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "letter" });
      const marginPt = 24;

      // Add report pages
      await canvasToPagedPdf(pdf, canvas, marginPt);

      // Add receipt pages (2 per page, bigger/legible)
      setStatus("Adding receipts (2 per page)…", "");
      await addReceiptPages(pdf, marginPt);

      // Return Blob
      return pdf.output("blob");
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 4000);
    }

    function buildMailto(subject, body){
      return `mailto:${EMAIL_TO}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    async function doDownload(){
      clearStatus();
      try{
        if (!filenameEl.value.trim()) filenameEl.value = buildDefaultFilename();
        const outName = sanitizeFilename(filenameEl.value) + ".pdf";

        const blob = await generatePdfBlob();
        downloadBlob(blob, outName);

        setStatus("PDF downloaded.", "ok");
      } catch(e){
        setStatus("Export failed, " + String(e?.message || e), "bad");
      }
    }

    async function doSubmit(){
      clearStatus();
      try{
        if (!filenameEl.value.trim()) filenameEl.value = buildDefaultFilename();
        const outName = sanitizeFilename(filenameEl.value) + ".pdf";

        await doDownload();

        const subject = `Expense Report Submission, ${employeeNameEl.value || "Employee"}, ${reportDateEl.value || ""}`;
        const body =
`Hi Timesheets,

Please find my Expense Report attached.

Employee: ${employeeNameEl.value || ""}
Report Date: ${reportDateEl.value || ""}
File Name: ${outName}
Form Version: ${VERSION}

Next step,
Attach the downloaded PDF and send.

Thanks,`;

        setTimeout(() => {
          window.location.href = buildMailto(subject, body);
          setStatus("Email draft opened. Attach the downloaded PDF, then send.", "ok");
        }, 350);

      } catch(e){
        setStatus("Submit failed, " + String(e?.message || e), "bad");
      }
    }

    // Events
    addRowBtn.addEventListener("click", addRow);
    removeLastRowBtn.addEventListener("click", removeLastRow);

    receiptPhotosInput.addEventListener("change", async () => {
      clearStatus();
      try{ await rebuildReceiptPreviewAndCache(); }
      catch(e){ setStatus("Receipt load failed, " + String(e?.message || e), "bad"); }
    });

    clearReceiptsBtn.addEventListener("click", clearReceipts);

    exportBtn.addEventListener("click", doDownload);
    submitBtn.addEventListener("click", doSubmit);

    clearBtn.addEventListener("click", () => {
      clearStatus();
      document.getElementById("expenseForm").reset();
      initRows();
      clearReceipts();
      const today = new Date().toISOString().slice(0,10);
      reportDateEl.value = today;
      filenameEl.value = buildDefaultFilename();
    });

    // Init
    (function init(){
      initRows();
      const today = new Date().toISOString().slice(0,10);
      if (!reportDateEl.value) reportDateEl.value = today;
      filenameEl.value = buildDefaultFilename();
      receiptCountText.textContent = "No receipts selected.";
      receiptPreview.innerHTML = "";
    })();
  </script>
</body>
</html>
